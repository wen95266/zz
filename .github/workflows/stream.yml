
name: Telegram Live Stream

on:
  repository_dispatch:
    types: [start_stream]
  workflow_dispatch:
    inputs:
      video_url:
        description: 'Video URL'
        required: true
      rtmp_url:
        description: 'RTMP URL'
        required: true
      alist_token:
        description: 'Alist Token'
        required: false

jobs:
  stream:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # æœ€é•¿è¿è¡Œ 6 å°æ—¶

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Install FFmpeg
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg

    - name: Start Streaming
      env:
        # âš¡ï¸ æ ¸å¿ƒä¿®å¤: ä½¿ç”¨ GitHub è¡¨è¾¾å¼ (||) å¤„ç†å˜é‡
        # å¦‚æœæ˜¯ Bot è§¦å‘ (client_payload)ï¼Œåˆ™ä½¿ç”¨å‰è€…
        # å¦‚æœæ˜¯ æ‰‹åŠ¨è§¦å‘ (inputs)ï¼Œåˆ™ä½¿ç”¨åè€…
        VIDEO_URL: ${{ github.event.client_payload.video_url || inputs.video_url }}
        RTMP_URL: ${{ github.event.client_payload.rtmp_url || inputs.rtmp_url }}
        ALIST_TOKEN: ${{ github.event.client_payload.alist_token || inputs.alist_token }}
      run: |
        echo "---------------------------------------------------"
        echo "ğŸš€ ä»»åŠ¡å¯åŠ¨ç¡®è®¤"
        echo "ğŸ“¡ è§†é¢‘åœ°å€: $VIDEO_URL"
        echo "ğŸ“º æ¨æµç›®æ ‡: RTMP Server"
        echo "---------------------------------------------------"

        if [[ -z "$VIDEO_URL" ]] || [[ -z "$RTMP_URL" ]]; then
          echo "âŒ è‡´å‘½é”™è¯¯: å˜é‡è¯»å–å¤±è´¥ï¼Œåœ°å€ä¸ºç©ºï¼"
          exit 1
        fi

        # æ„å»º FFmpeg å‘½ä»¤æ•°ç»„
        CMD=(ffmpeg -re)
        
        # ç½‘ç»œä¼˜åŒ–å‚æ•°
        CMD+=(-reconnect 1 -reconnect_at_eof 1 -reconnect_streamed 1 -reconnect_delay_max 5)
        CMD+=(-rw_timeout 15000000)
        CMD+=(-user_agent "Mozilla/5.0")

        # é‰´æƒ Headers
        if [[ -n "$ALIST_TOKEN" ]]; then
           echo "ğŸ”‘ æ£€æµ‹åˆ° Tokenï¼Œå·²æ³¨å…¥ Headers"
           CMD+=(-headers "Authorization: $ALIST_TOKEN")
        fi

        # è¾“å…¥ä¸è¾“å‡º
        CMD+=(-i "$VIDEO_URL")
        CMD+=(-c:v copy -c:a aac -ar 44100 -b:a 128k -ac 2)
        CMD+=(-f flv "$RTMP_URL")

        echo "â–¶ï¸ å¼€å§‹è¿è¡Œ FFmpeg..."
        "${CMD[@]}"
